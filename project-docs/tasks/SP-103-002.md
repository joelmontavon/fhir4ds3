# Task SP-103-002: Unary Polarity Operator

**Created:** 2026-01-25
**Status:** Pending
**Priority:** HIGH (Quick Win)
**Estimated Impact:** +3.4% (32 tests)

## Description

Fix unary polarity operator (-expr) to properly generate SQL and handle edge cases.

## Failing Tests (32 tests)

### Primary Issues:
1. **Unary Negation**: `-expr` not properly translated to SQL
2. **Operator Precedence**: Unary minus precedence with arithmetic operations
3. **Nested Unary**: Multiple unary operators (e.g., `--5`)

### Sample Failures:
- Various tests with negative numeric literals
- Unary minus in expressions
- Unary minus with parentheses

## Root Cause Analysis

Current implementation:
1. Unary operator not properly recognized in parser
2. SQL generation for unary minus incorrect
3. Operator precedence not properly handled

## Implementation Plan

### Step 1: Fix Parser Recognition
**File:** `fhir4ds/fhirpath/parser_core/expression_parser.py`

Ensure unary minus is recognized as a unary operator, not binary.

### Step 2: Add AST Node
**File:** `fhir4ds/fhirpath/ast/nodes.py`

Add or verify `UnaryExpression` node with proper structure.

### Step 3: Update SQL Translator
**File:** `fhir4ds/fhirpath/sql/translators/expression_translator.py`

Generate proper SQL for unary expressions:
- FHIRPath: `-5`
- SQL: `-(5)` or `(-5)`

### Step 4: Handle Edge Cases
- Unary minus before literals
- Unary minus before identifiers
- Multiple unary operators

## Testing Strategy

1. **Unit Tests:**
   - Test parsing of unary expressions
   - Test SQL generation
   - Test edge cases

2. **Compliance Tests:**
   - Run: `python3 run_baseline_compliance.py`
   - Verify 32 additional tests pass

3. **Database Parity:**
   - Test on DuckDB
   - Validate PostgreSQL SQL generation

## Acceptance Criteria

- [ ] All 32 unary polarity tests pass
- [ ] No existing tests break
- [ ] Dual-database parity maintained
- [ ] Code follows unified FHIRPath architecture

## Dependencies

None (Quick Win)

## Branch

`git checkout -b SP-103-002-unary-polarity`

## Commit Message

```
feat(SP-103-002): Unary polarity operator support (Task: SP-103-002)

- Fix parser recognition of unary minus operator
- Add proper AST node for unary expressions
- Update SQL translator for unary negation
- Handle operator precedence correctly

Fixes 32 failing tests in official FHIRPath compliance suite.
```
