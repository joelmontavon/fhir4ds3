# Task SP-103-011: Collection Functions - CTE Propagation

**Created:** 2026-01-25
**Status:** Pending
**Priority:** HIGH (Collections)
**Estimated Impact:** +2.1% (20 tests)

## Description

Fix collection functions (where, select, first) to properly propagate columns through CTEs.

## Failing Tests (20 tests)

### Primary Issues:
1. **where() Function**: Column propagation through CTEs
2. **select() Function**: Column propagation through CTEs
3. **first() Function**: Column propagation through CTEs
4. **$this Variable**: Context variable in predicates

### Sample Failures:
- `testDollarThis1`: `Patient.name.given.where(substring($this.length()-3) = 'out')`
- `testDollarThis2`: `Patient.name.given.where(substring($this.length()-3) = 'ter')`

## Root Cause Analysis

Current implementation:
1. CTE column propagation may be incomplete
2. $this variable context not properly maintained
3. Nested collection functions may lose column context

## Implementation Plan

### Step 1: Review CTE Column Propagation
**File:** `fhir4ds/fhirpath/sql/translators/function_translator.py`

Review how columns are propagated through CTEs in:
- where() function
- select() function
- first() function

### Step 2: Fix $this Variable Context
Ensure $this variable properly refers to current item in collection.

### Step 3: Improve CTE Generation
Ensure all necessary columns are propagated through CTE chain.

### Step 4: Test Nested Functions
Test deeply nested collection function calls.

## Testing Strategy

1. **Unit Tests:**
   - Test where() with various predicates
   - Test select() with various projections
   - Test first() function
   - Test nested collection functions

2. **Compliance Tests:**
   - Run: `python3 run_baseline_compliance.py`
   - Verify 20 additional tests pass

3. **Database Parity:**
   - Test on DuckDB
   - Validate PostgreSQL SQL generation

## Acceptance Criteria

- [ ] All 20 collection function tests pass
- [ ] No existing tests break
- [ ] Dual-database parity maintained
- [ ] Code follows unified FHIRPath architecture

## Dependencies

None

## Branch

`git checkout -b SP-103-011-collection-cte-propagation`

## Commit Message

```
feat(SP-103-011): Collection function CTE propagation (Task: SP-103-011)

- Fix column propagation in where() function
- Fix column propagation in select() function
- Fix column propagation in first() function
- Improve $this variable context handling
- Enhance CTE generation for nested functions

Fixes 20 failing tests in official FHIRPath compliance suite.
```
