# Task SP-103-017: Integration & Edge Cases

**Created:** 2026-01-25
**Status:** Pending
**Priority:** LOW (Integration)
**Estimated Impact:** +8.4% (78 "Other" tests)

## Description

Fix integration issues and remaining edge cases not covered by previous tasks.

## Failing Tests (78 "Other" tests)

### Primary Issues:
1. **Context Issues**: Wrong resource type context
2. **Path Resolution**: Complex path resolution issues
3. **Integration**: Integration between multiple features
4. **Unknown**: Issues not categorized by primary failure modes

### Sample Failures:
- `testPolymorphismA`: `Observation.value.unit` (context issue - needs Observation resource)
- `testDollarThis1`: `Patient.name.given.where(substring($this.length()-3) = 'out')`
- Various other integration issues

## Root Cause Analysis

Multiple root causes:
1. Test fixtures incomplete (missing Observation resources)
2. Complex path resolution issues
3. Integration between multiple features
4. Edge cases in expression evaluation

## Implementation Plan

### Step 1: Complete Test Fixtures
**File:** `run_baseline_compliance.py`

Add comprehensive test fixtures:
- Observation resources with various value types
- Other resource types as needed
- Complex nested structures

### Step 2: Fix Path Resolution
**File:** `fhir4ds/fhirpath/path/resolver.py`

Fix any path resolution issues.

### Step 3: Fix Integration Issues
Fix integration between features:
- Type checking + collection functions
- String functions + predicates
- etc.

### Step 4: Investigate Unknown Failures
Run detailed investigation on remaining failures.

## Testing Strategy

1. **Unit Tests:**
   - Test integration scenarios
   - Test edge cases

2. **Compliance Tests:**
   - Run: `python3 run_baseline_compliance.py`
   - Verify 78 additional tests pass

3. **Database Parity:**
   - Test on DuckDB
   - Validate PostgreSQL SQL generation

## Acceptance Criteria

- [ ] All 78 "Other" tests pass
- [ ] No existing tests break
- [ ] Dual-database parity maintained
- [ ] Code follows unified FHIRPath architecture
- [ ] **100% compliance achieved (934/934)**

## Dependencies

ALL previous tasks (this is the final integration task)

## Branch

`git checkout -b SP-103-017-integration-edge-cases`

## Commit Message

```
feat(SP-103-017): Integration and edge cases (Task: SP-103-017)

- Complete test fixtures for all resource types
- Fix path resolution issues
- Fix integration between features
- Resolve remaining edge cases
- ACHIEVE 100% COMPLIANCE (934/934 tests)

Fixes 78 failing tests in official FHIRPath compliance suite.
FINAL TASK: Achieves 100% compliance target.
```
