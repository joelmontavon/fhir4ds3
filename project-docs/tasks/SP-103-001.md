# Task SP-103-001: DateTime Literal Parsing

**Created:** 2026-01-25
**Status:** Pending
**Priority:** HIGH (Quick Win)
**Estimated Impact:** +2.3% (21 tests)

## Description

Fix DateTime literal parsing to support partial date/time formats specified in FHIRPath specification.

## Failing Tests (21 tests)

### Primary Issues:
1. **Time Literals**: `@T14`, `@T14:34:28Z`, `@T14:34:28+10:00` formats
2. **DateTime-Timezone**: Timezone offset handling in DateTime literals
3. **Partial Dates**: Year-only and year-month formats

### Sample Failures:
- `testLiteralTimeHour`: `@T14.is(Time)`
- `testLiteralTimeUTC`: `@T14:34:28Z.is(Time)` (marked as invalid but should be valid)
- `testLiteralTimeTimezoneOffset`: `@T14:34:28+10:00.is(Time)` (marked as invalid but should be valid)

## Root Cause Analysis

Current parser does not fully implement FHIRPath DateTime literal grammar:
- Time literals without timezone support
- Timezone offset parsing incomplete
- Validation logic incorrectly rejects valid timezone formats

## Implementation Plan

### Step 1: Extend DateTime Literal Parser
**File:** `fhir4ds/fhirpath/parser_core/literal_parser.py`

Add support for:
1. Time-only literals: `@T14`, `@T14:34:28`
2. Timezone offsets: `Z`, `+10:00`, `-05:00`
3. Partial date formats: `@2015`, `@2015-02`

### Step 2: Fix Semantic Validation
**File:** `fhir4ds/fhirpath/parser_core/semantic_validator.py`

Remove incorrect rejection of:
- Time literals with UTC timezone (`Z`)
- Time literals with offset timezones (`+HH:MM`, `-HH:MM`)

### Step 3: Update SQL Generation
**File:** `fhir4ds/fhirpath/sql/translators/literal_translator.py`

Ensure proper SQL generation for new literal formats.

## Testing Strategy

1. **Unit Tests:**
   - Test parsing of all time literal formats
   - Test timezone offset parsing
   - Test semantic validation acceptance

2. **Compliance Tests:**
   - Run: `python3 run_baseline_compliance.py`
   - Verify 21 additional tests pass

3. **Database Parity:**
   - Test on DuckDB
   - Validate PostgreSQL SQL generation

## Acceptance Criteria

- [ ] All 21 DateTime literal tests pass
- [ ] No existing tests break
- [ ] Dual-database parity maintained
- [ ] Code follows unified FHIRPath architecture

## Dependencies

None (Quick Win)

## Branch

`git checkout -b SP-103-001-datetime-literals`

## Commit Message

```
feat(SP-103-001): DateTime literal parsing support (Task: SP-103-001)

- Add support for time-only literals (@T14, @T14:34:28)
- Fix timezone offset parsing (Z, +HH:MM, -HH:MM)
- Remove incorrect semantic validation rejections
- Update SQL generation for new literal formats

Fixes 21 failing tests in official FHIRPath compliance suite.
```
