# Task SP-103-003: Quantity Literals

**Created:** 2026-01-25
**Status:** Pending
**Priority:** HIGH (Quick Win)
**Estimated Impact:** +8.6% (80 tests)

## Description

Fix Quantity literal parsing and UCUM unit handling.

## Failing Tests (80 tests)

### Primary Issues:
1. **UCUM Units**: Unit codes like `'days'`, `'kg'`, `'mg'`, `'cm'` not recognized
2. **Quantity Syntax**: `5 days`, `10 kg` format parsing
3. **Unit Validation**: Proper UCUM unit validation
4. **convertsToQuantity**: Quantity type conversion functions

### Sample Failures:
- `testLiteralQuantityDay`: `4 days.convertsToQuantity()`
- Various tests with UCUM units
- Quantity literal expressions

## Root Cause Analysis

Current implementation:
1. Quantity literal parser incomplete or missing
2. UCUM unit catalog not implemented
3. convertsToQuantity() function not implemented
4. Quantity type validation incomplete

## Implementation Plan

### Step 1: Implement Quantity Literal Parser
**File:** `fhir4ds/fhirpath/parser_core/literal_parser.py`

Parse quantity literals:
- Syntax: `<number> <unit>`
- Examples: `5 days`, `10 kg`, `2.5 mg`

### Step 2: Add UCUM Unit Support
**File:** `fhir4ds/fhirpath/ucum/units.py` (new file)

Create UCUM unit catalog and validation:
- Common units: days, kg, mg, cm, m, L, etc.
- Unit prefix support: k, m, M, etc.
- Unit validation logic

### Step 3: Implement convertsToQuantity()
**File:** `fhir4ds/fhirpath/functions/type_conversion.py`

Add function to check if value can be converted to Quantity.

### Step 4: Update SQL Translator
**File:** `fhir4ds/fhirpath/sql/translators/literal_translator.py`

Generate proper SQL for Quantity literals.

## Testing Strategy

1. **Unit Tests:**
   - Test quantity literal parsing
   - Test UCUM unit validation
   - Test convertsToQuantity() function

2. **Compliance Tests:**
   - Run: `python3 run_baseline_compliance.py`
   - Verify 80 additional tests pass

3. **Database Parity:**
   - Test on DuckDB
   - Validate PostgreSQL SQL generation

## Acceptance Criteria

- [ ] All 80 quantity literal tests pass
- [ ] No existing tests break
- [ ] Dual-database parity maintained
- [ ] Code follows unified FHIRPath architecture

## Dependencies

None (Quick Win)

## Branch

`git checkout -b SP-103-003-quantity-literals`

## Commit Message

```
feat(SP-103-003): Quantity literal and UCUM unit support (Task: SP-103-003)

- Implement quantity literal parser (number + unit syntax)
- Add UCUM unit catalog and validation
- Implement convertsToQuantity() function
- Update SQL translator for quantity literals

Fixes 80 failing tests in official FHIRPath compliance suite.
```
