# Task SP-103-005: Simple Arithmetic Fixes

**Created:** 2026-01-25
**Status:** Pending
**Priority:** HIGH (Quick Win)
**Estimated Impact:** +1.4% (13 tests)

## Description

Fix simple arithmetic operator issues in comparison and mathematical operations.

## Failing Tests (13 tests)

### Primary Issues:
1. **Comparison with Decimals**: Comparing Decimal values with Integer values
2. **Arithmetic Edge Cases**: Division, modulo operations
3. **Type Coercion**: Proper type handling in arithmetic operations

### Sample Failures:
- `testLiteralDecimalGreaterThanNonZeroTrue`: `Observation.value.value > 180.0`
- `testLiteralDecimalGreaterThanZeroTrue`: `Observation.value.value > 0.0`
- `testLiteralDecimalGreaterThanIntegerTrue`: `Observation.value.value > 0`
- `testLiteralDecimalLessThanInteger`: `Observation.value.value < 190`

## Root Cause Analysis

Current implementation:
1. Observation resource context not properly set up for testing
2. Comparison operators may have type coercion issues
3. Arithmetic operations edge cases not handled

## Implementation Plan

### Step 1: Fix Test Context
**File:** `run_baseline_compliance.py` or test setup

Add Observation resources to test data:
```json
{
  "resourceType": "Observation",
  "id": "1",
  "value": {
    "value": 185.5,
    "unit": "kg"
  }
}
```

### Step 2: Review Comparison Operators
**File:** `fhir4ds/fhirpath/sql/translators/operator_translator.py`

Ensure proper type coercion in comparisons:
- Decimal vs Integer
- Integer vs Decimal
- Null handling

### Step 3: Fix Arithmetic Edge Cases
- Division by zero
- Modulo operations
- Overflow handling

## Testing Strategy

1. **Unit Tests:**
   - Test comparison operators with mixed types
   - Test arithmetic edge cases

2. **Compliance Tests:**
   - Run: `python3 run_baseline_compliance.py`
   - Verify 13 additional tests pass

3. **Database Parity:**
   - Test on DuckDB
   - Validate PostgreSQL SQL generation

## Acceptance Criteria

- [ ] All 13 arithmetic tests pass
- [ ] No existing tests break
- [ ] Dual-database parity maintained
- [ ] Code follows unified FHIRPath architecture

## Dependencies

None (Quick Win)

## Branch

`git checkout -b SP-103-005-simple-arithmetic`

## Commit Message

```
feat(SP-103-005): Simple arithmetic fixes (Task: SP-103-005)

- Fix comparison operators with mixed types
- Add Observation test fixtures
- Handle arithmetic edge cases
- Improve type coercion in comparisons

Fixes 13 failing tests in official FHIRPath compliance suite.
```
