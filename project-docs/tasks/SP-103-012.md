# Task SP-103-012: Collection Functions - Nested Arrays

**Created:** 2026-01-25
**Status:** Pending
**Priority:** HIGH (Collections)
**Estimated Impact:** +1.1% (estimated 10 tests)

## Description

Fix collection functions when dealing with nested arrays and deeply nested structures.

## Failing Tests (estimated)

### Primary Issues:
1. **Nested Arrays**: Arrays within arrays
2. **Deep Nesting**: Multiple levels of nesting
3. **Array Operations**: Functions on nested arrays

## Root Cause Analysis

Nested array handling in collection functions may be incomplete.

## Implementation Plan

### Step 1: Review Nested Array Handling
**File:** `fhir4ds/fhirpath/sql/translators/function_translator.py`

Review how nested arrays are handled.

### Step 2: Fix Nested Array Operations
Ensure proper handling of:
- Arrays within arrays
- Nested collection functions
- Deep path navigation

### Step 3: Update SQL Generation
Generate proper SQL for nested array operations.

## Testing Strategy

1. **Unit Tests:**
   - Test nested array operations
   - Test deep nesting scenarios
   - Test edge cases

2. **Compliance Tests:**
   - Run: `python3 run_baseline_compliance.py`
   - Verify additional tests pass

3. **Database Parity:**
   - Test on DuckDB
   - Validate PostgreSQL SQL generation

## Acceptance Criteria

- [ ] All nested array tests pass
- [ ] No existing tests break
- [ ] Dual-database parity maintained
- [ ] Code follows unified FHIRPath architecture

## Dependencies

SP-103-011 (CTE Propagation)

## Branch

`git checkout -b SP-103-012-collection-nested-arrays`

## Commit Message

```
feat(SP-103-012): Collection function nested arrays (Task: SP-103-012)

- Fix nested array handling in collection functions
- Improve deep nesting support
- Update SQL generation for nested arrays

Fixes failing tests in official FHIRPath compliance suite.
```
