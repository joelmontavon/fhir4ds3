# Task SP-103-009: Comparison Operators - Type Coercion

**Created:** 2026-01-25
**Status:** Pending
**Priority:** HIGH (Comparisons)
**Estimated Impact:** +4.7% (44 tests)

## Description

Fix comparison operators to properly handle type coercion and type mismatches.

## Failing Tests (44 tests)

### Primary Issues:
1. **Type Coercion**: Comparing values of different types
2. **String Comparisons**: String equality and ordering
3. **Numeric Comparisons**: Integer vs Decimal comparisons
4. **Null Handling**: Proper null handling in comparisons
5. **Collection Comparisons**: Comparing collections vs singletons

## Root Cause Analysis

Current implementation:
1. Type coercion logic incomplete
2. Comparison operators may not handle all type combinations
3. Null handling may be incorrect
4. Collection comparison logic may have issues

## Implementation Plan

### Step 1: Review Comparison Operators
**File:** `fhir4ds/fhirpath/sql/translators/operator_translator.py`

Review all comparison operators: =, !=, <, <=, >, >=

### Step 2: Add Type Coercion Logic
Implement FHIRPath type coercion rules:
- String + String → direct comparison
- Integer + Decimal → coerce to Decimal
- Integer + Integer → direct comparison
- Decimal + Decimal → direct comparison
- Boolean + Boolean → direct comparison
- Incompatible types → return null (or empty)

### Step 3: Handle Null Values
Ensure proper null handling:
- null = null → true
- null = anything → null (empty)
- anything = null → null (empty)

### Step 4: Collection Comparisons
Handle collection comparisons properly.

## Testing Strategy

1. **Unit Tests:**
   - Test all comparison operators
   - Test type coercion scenarios
   - Test null handling
   - Test collection comparisons

2. **Compliance Tests:**
   - Run: `python3 run_baseline_compliance.py`
   - Verify 44 additional tests pass

3. **Database Parity:**
   - Test on DuckDB
   - Validate PostgreSQL SQL generation

## Acceptance Criteria

- [ ] All 44 comparison tests pass
- [ ] No existing tests break
- [ ] Dual-database parity maintained
- [ ] Code follows unified FHIRPath architecture

## Dependencies

None

## Branch

`git checkout -b SP-103-009-comparison-type-coercion`

## Commit Message

```
feat(SP-103-009): Comparison operator type coercion (Task: SP-103-009)

- Implement proper type coercion for comparison operators
- Fix null handling in comparisons
- Handle collection comparisons correctly
- Add comprehensive type coercion rules

Fixes 44 failing tests in official FHIRPath compliance suite.
```
